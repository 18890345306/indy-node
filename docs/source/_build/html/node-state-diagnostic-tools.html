

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Node State Diagnostic Tools Workflow &mdash; Hyperledger Indy Node  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pool Upgrade Guideline" href="pool-upgrade.html" />
    <link rel="prev" title="Node Monitoring Tools for Stewards" href="node-monitoring-tools-for-stewards.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Hyperledger Indy Node
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="start-nodes.html">Create a Network and Start Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="add-node.html">Add Node to Existing Pool</a></li>
<li class="toctree-l1"><a class="reference internal" href="auth_rules.html">Current implemented rules in auth_map</a></li>
<li class="toctree-l1"><a class="reference internal" href="ci-cd.html">Continuous Integration / Delivery</a></li>
<li class="toctree-l1"><a class="reference internal" href="cluster-simulation.html">Running a Simulation of a Indy Cluster and Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="helper-scripts.html">Helper Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="indy-file-structure-guideline.html">Indy File Folders Structure Guideline</a></li>
<li class="toctree-l1"><a class="reference internal" href="indy-running-locally.html">Indy – Running the Getting Started tutorial locally</a></li>
<li class="toctree-l1"><a class="reference internal" href="indy-running-locally.html#resetting-the-indy-environment">Resetting the Indy environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-monitoring-tools-for-stewards.html">Node Monitoring Tools for Stewards</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Node State Diagnostic Tools Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nscapture">nscapture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nsreplay">nsreplay</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nsdiff">nsdiff</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#workflow">Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#steps">Steps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-configure-recording">Step #1 - Configure recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-get-indy-into-the-desired-state">Step #2 - Get indy into the desired state</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-capture-node-state-and-recording">Step #3 - Capture Node state and recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-replay-recording">Step #4 - Replay recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-5-capture-replayed-node-state">Step #5 - Capture replayed Node state</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-6-diff-captured-node-state-with-capatured-replay-state">Step #6 - Diff captured Node state with capatured replay state</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pool-upgrade.html">Pool Upgrade Guideline</a></li>
<li class="toctree-l1"><a class="reference internal" href="requests-new.html">Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup-dev.html">Dev Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup-iptables.html">Setup iptables rules (recommended)</a></li>
<li class="toctree-l1"><a class="reference internal" href="transactions.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="write-code-guideline.html">Code quality requirements guideline</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.3_to_1.4_migration_guide.html">List of breaking changes for migration from indy-node 1.3 to 1.4</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Hyperledger Indy Node</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Node State Diagnostic Tools Workflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/node-state-diagnostic-tools.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="node-state-diagnostic-tools-workflow">
<span id="node-state-diagnostic-tools-workflow"></span><h1>Node State Diagnostic Tools Workflow<a class="headerlink" href="#node-state-diagnostic-tools-workflow" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="introduction"></span><h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The Node state diagnostic tools are for working with indy node and its state.
The tools are intended to work with the recorder functionality and should help
with diagnostic work in the indy-node development and QA workflows.</p>
<p>There are currently three scripts located in tools/diagnostics. They are
nscapture, nsreplay and nsdiff. Basic functionality and intended workflow are
documented below.</p>
<p>This documentation is high level and will lack complete detail about the
parameters and options for these scripts.  Please see the ‘-h’ output from the
script for more details.</p>
</div>
<div class="section" id="nscapture">
<span id="nscapture"></span><h2>nscapture<a class="headerlink" href="#nscapture" title="Permalink to this headline">¶</a></h2>
<p>nscapture has no required parameters and makes the following assumptions.
These assumptions should work in most production like environments (QA
environments or other Debian install environments).</p>
<p><strong>Assumptions:</strong></p>
<ol class="simple">
<li>ROOT_DIR: nscapture will assume that the root directory is the base of the
filesystem (‘/’). This should be correct for Debian installed systems. For other
installation patterns, the ‘-o’ flag can be used to point to another location.</li>
<li>NODE_NAME: nscapture will look for nodes; starting it’s search from the root
directory. If only one node configuration is found, nscapture will capture it.
Otherwise, nscapture will require the user to specify which node to capture.
Most nodes will only have one configuration. The ‘-n’ option can be used to
specify the desired node to capture.</li>
<li>OUTPUT_DIR: By default, nscatpure will output the archive to the current
working directory of the running process. If another location is desired,
the ‘-o’ option can be used.</li>
</ol>
<p><strong>Other Notes</strong></p>
<ul class="simple">
<li>Capture file name structure is:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">&gt;.&lt;</span><span class="n">pool</span> <span class="n">name</span><span class="o">&gt;.&lt;</span><span class="n">capture</span> <span class="n">date</span><span class="o">&gt;.&lt;</span><span class="n">file</span> <span class="n">extension</span><span class="o">&gt;</span>

<span class="n">ex</span><span class="p">:</span>
<span class="n">Node1</span><span class="o">.</span><span class="n">sandbox</span><span class="o">.</span><span class="mf">20180517163819.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>This format is expected by the other scripts.</p>
</div>
<div class="section" id="nsreplay">
<span id="nsreplay"></span><h2>nsreplay<a class="headerlink" href="#nsreplay" title="Permalink to this headline">¶</a></h2>
<p>If a node’s nscapture archive contains a recording, nsreplay starts a single
instance of indy-node and replays captured events (mostly messages) using
replay logic in Plenum.</p>
<p><strong>Assumptions</strong></p>
<ol class="simple">
<li>Node state was captured using nscapture.</li>
<li>HAS RECORDING: The replay requires a recording to replay. See doc/recorder.md
in indy-plenum for details on how to configure the recorder. nscapture captures
the recording in <code class="docutils literal notranslate"><span class="pre">data/&lt;node</span> <span class="pre">name&gt;/recorder/*</span></code>.</li>
</ol>
<p><strong>Other Notes</strong></p>
</div>
<div class="section" id="nsdiff">
<span id="nsdiff"></span><h2>nsdiff<a class="headerlink" href="#nsdiff" title="Permalink to this headline">¶</a></h2>
<p>nsdiff will compare two nscapture archives. The result will highlight what parts
of the Node state are different and how they differ in *nix diff format. The
contents of the nscapture archives dictates what is being compared. What
nscapture captures for comparison may change over time. There are comments in
the nsdiff script that describe what is being compared and how to get a
comprehensive list of things being compared.</p>
<p>nsdiff is intended to help understand how node state differs between different
nodes in the same cluster or between a node and it’s replayed state. It is not
inteneded to lessen/reduce the need for in-depth understanding of the Indy
codebase.</p>
<p><strong>Assumptions</strong></p>
<ol class="simple">
<li>Node state was captured using nscapture.</li>
</ol>
<p><strong>Other Notes</strong></p>
<p>When using nsdiff to compare a node and it’s replayed state, you will be required to do the following:</p>
<ol class="simple">
<li>Run nscapture on a node. This will produce a <code class="docutils literal notranslate"><span class="pre">*.tar.gz</span></code> file.</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ nscapture
</pre></div>
</div>
<ol class="simple">
<li>Run nsreplay on the Node State Archive (<code class="docutils literal notranslate"><span class="pre">*.tar.gz</span></code>) captured in step 1, explicitly defining an output directory in which to write replayed state. Note that nsreplay does not have to be run on the node where the Node State Archive was captured. An equivalent development environment with compatible versions of indy-node, indy-plenum, etc. is recommended, because you will also have visual debug tools available (i.e. PyCharm)</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ nsreplay -o &lt;OUTPUT_DIR&gt; &lt;step <span class="m">1</span> *.tar.gz&gt;
</pre></div>
</div>
<ol class="simple">
<li>Run nscapture with step 2 <code class="docutils literal notranslate"><span class="pre">&lt;OUTPUT_DIR&gt;</span></code> as the ROOT_DIR to capture the replayed state. This will create another <code class="docutils literal notranslate"><span class="pre">*.tar.gz</span></code></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ nscapture -r &lt;step <span class="m">2</span> OUTPUT_DIR&gt;
</pre></div>
</div>
<ol class="simple">
<li>nsdiff the two Node State Archives</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ nsdiff &lt;step <span class="m">1</span> *.tar.gz&gt; &lt;step <span class="m">3</span> *.tar.gz&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="workflow">
<span id="workflow"></span><h1>Workflow<a class="headerlink" href="#workflow" title="Permalink to this headline">¶</a></h1>
<p>The following is a simple but hopefully a common workflow for using these tools.</p>
<div class="section" id="steps">
<span id="steps"></span><h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-1-configure-recording">
<span id="step-1-configure-recording"></span><h3>Step #1 - Configure recording<a class="headerlink" href="#step-1-configure-recording" title="Permalink to this headline">¶</a></h3>
<p>Add STACK_COMPANION to
/etc/indy/indy_config.py if using indy-node version &gt;= 1.4.485
/etc/indy/plenum_config.py otherwise
and set to the value to 1 (numeric value, NOT a String).</p>
<p>The value 0 will DISABLE recording.</p>
<p>The value 1 will ENABLE recording.</p>
<p>Indy will require a restart for the configuration to take effect.</p>
</div>
<div class="section" id="step-2-get-indy-into-the-desired-state">
<span id="step-2-get-indy-into-the-desired-state"></span><h3>Step #2 - Get indy into the desired state<a class="headerlink" href="#step-2-get-indy-into-the-desired-state" title="Permalink to this headline">¶</a></h3>
<p>Run load or other experiments to get the node into the desired state. This step
is open-ended and up to the desires/objectives of the person using the workflow.</p>
</div>
<div class="section" id="step-3-capture-node-state-and-recording">
<span id="step-3-capture-node-state-and-recording"></span><h3>Step #3 - Capture Node state and recording<a class="headerlink" href="#step-3-capture-node-state-and-recording" title="Permalink to this headline">¶</a></h3>
<p>In the environment (on the server, VM, docker container, etc) where Indy is
running, stop Indy (indy-node service) and then run nscapture. Doing this
will produce an archive. This archive could be large depending on the state of
the node. Every message for every instance will be contained in the recording.
The archive must be moved to the environment where the replay will be performed.
That can be done via SCP or similar method.</p>
</div>
<div class="section" id="step-4-replay-recording">
<span id="step-4-replay-recording"></span><h3>Step #4 - Replay recording<a class="headerlink" href="#step-4-replay-recording" title="Permalink to this headline">¶</a></h3>
<p>In a development environment, use nsreplay to replay the recording. Currently,
the replay will take a similar amount of time compared to the recording. During
the replay, debugging and other development tools should be usable.</p>
</div>
<div class="section" id="step-5-capture-replayed-node-state">
<span id="step-5-capture-replayed-node-state"></span><h3>Step #5 - Capture replayed Node state<a class="headerlink" href="#step-5-capture-replayed-node-state" title="Permalink to this headline">¶</a></h3>
<p>In the environment (on the server, VM, docker container, etc) where nsreplay was
run, execute nscapture to capture the replayed state.</p>
</div>
<div class="section" id="step-6-diff-captured-node-state-with-capatured-replay-state">
<span id="step-6-diff-captured-node-state-with-capatured-replay-state"></span><h3>Step #6 - Diff captured Node state with capatured replay state<a class="headerlink" href="#step-6-diff-captured-node-state-with-capatured-replay-state" title="Permalink to this headline">¶</a></h3>
<p>If desired, the nsdiff can be used to check that the replay was able to
reproduce the same state as the recording.  Use nsdiff to check the difference
between the states. Ideally, they will be identical but if they are different,
insight might still be gained.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="pool-upgrade.html" class="btn btn-neutral float-right" title="Pool Upgrade Guideline" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="node-monitoring-tools-for-stewards.html" class="btn btn-neutral" title="Node Monitoring Tools for Stewards" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Hyperledger

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>